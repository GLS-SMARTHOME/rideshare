<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live Route to User (Google Maps + RTDB)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0b0c; color:#fff; }
    #map { position: absolute; inset: 56px 0 0 0; }
    .topbar {
      position: fixed; top: 0; left: 0; right: 0; height: 56px;
      display:flex; gap:.5rem; align-items:center; padding: .5rem .75rem; 
      background: rgba(16,16,20,.8); backdrop-filter: blur(8px); z-index: 10;
      box-shadow: 0 2px 10px rgba(0,0,0,.25);
    }
    .btn {
      appearance:none; border:0; padding:.65rem .9rem; border-radius:14px; font-weight:600; cursor:pointer;
      background:#2f80ed; color:#fff; box-shadow: 0 6px 16px rgba(47,128,237,.35);
    }
    .btn.secondary { background:#23262f; color:#fff; box-shadow:none; border:1px solid #2b2e39; }
    .status { margin-left:auto; font-size:.9rem; opacity:.85; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .legend {
      position: fixed; bottom: 12px; left: 12px; z-index: 10;
      background: rgba(16,16,20,.85); backdrop-filter: blur(8px);
      padding: .6rem .75rem; border-radius: 12px; font-size:.9rem; border:1px solid rgba(255,255,255,.08)
    }
    .legend .item { display:flex; align-items:center; gap:.5rem; margin:.15rem 0; }
    .marker-swatch { width:18px; height:18px; display:inline-block; }
    /* AdvancedMarker content: allow smooth rotation */
    .car-wrapper { width: 40px; height: 40px; transform-origin: 50% 50%; transition: transform 80ms linear; }
    .person-wrapper { width: 36px; height: 36px; }
    /* Make sure controls are touch-friendly */
    @media (max-width: 420px) {
      .status { display:none; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <button id="startBtn" class="btn">Start</button>
    <button id="stopBtn" class="btn secondary" disabled>Stop</button>
    <button id="recenterBtn" class="btn secondary">Recenter</button>
    <div id="status" class="status">Ready</div>
  </div>
  <div id="map"></div>

  <div class="legend">
    <div class="item">
      <span class="marker-swatch" id="carSwatch"></span> You (car, follows compass)
    </div>
    <div class="item">
      <span class="marker-swatch" id="userSwatch"></span> User from RTDB
    </div>
  </div>

  <!-- Google Maps JS (Advanced Markers) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjdnkFWOnh1u2cWf5RFURytU8Zk3fmOhk"></script>

  <!-- Firebase v10+ (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // ===================== CONFIG =====================
    const firebaseConfig = {
  apiKey: "AIzaSyAIlkvwyaF6FPPbXBJDqHwuTS5S3QKG3l8",
  authDomain: "xoxo-store.firebaseapp.com",
  databaseURL: "https://xoxo-store-default-rtdb.firebaseio.com",
  projectId: "xoxo-store",
  storageBucket: "xoxo-store.firebasestorage.app",
  messagingSenderId: "667290233046",
  appId: "1:667290233046:web:dbbc9130ff38b0900f8177",
  measurementId: "G-XMJVCK8KMD"
  };
    const USER_LOCATION_RTD_PATH = "/users/target/location"; // { lat: number, lng: number }
    // ==================================================

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ======= Map + Markers =======
    let map, directionsService, directionsRenderer;
    let carMarker, personMarker;
    let carContentEl, personContentEl;

    // current positions
    let myPos = null;                 // {lat, lng} from Geolocation
    let userPos = null;               // {lat, lng} from RTDB
    let watchId = null;               // Geolocation watch ID
    let compassHeading = null;        // Degrees, 0=N

    // listeners / state
    let rtdbUnsubscribe = null;
    let routingActive = false;

    // init map
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 39.5, lng: -98.35 }, // US center default
        zoom: 5,
        mapId: "DEMO_MAP_ID" // optional: if you have a Cloud Styled Map ID, put it here
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map,
        suppressMarkers: true,
        polylineOptions: { strokeWeight: 6 }
      });

      // Build AdvancedMarker for car (rotatable HTML)
      carContentEl = document.createElement("div");
      carContentEl.className = "car-wrapper";
      carContentEl.innerHTML = carSVG();
      const { AdvancedMarkerElement } = google.maps.marker;
      carMarker = new AdvancedMarkerElement({
        map,
        position: { lat: 0, lng: 0 },
        content: carContentEl,
        zIndex: 5
      });

      // Human marker
      personContentEl = document.createElement("div");
      personContentEl.className = "person-wrapper";
      personContentEl.innerHTML = personSVG();
      personMarker = new AdvancedMarkerElement({
        map,
        position: { lat: 0, lng: 0 },
        content: personContentEl,
        zIndex: 4
      });

      // show little swatches in legend
      document.getElementById("carSwatch").innerHTML = carMiniSVG();
      document.getElementById("userSwatch").innerHTML = personMiniSVG();

      // UI buttons
      document.getElementById("startBtn").addEventListener("click", startAll);
      document.getElementById("stopBtn").addEventListener("click", stopAll);
      document.getElementById("recenterBtn").addEventListener("click", ()=> fitToBoth());
      setStatus("Ready");
    }

    // ======= Start / Stop =======
    async function startAll() {
      try {
        // iOS 13+ compass permission
        if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function") {
          try {
            const resp = await DeviceOrientationEvent.requestPermission();
            if (resp === "granted") attachCompass();
          } catch (e) {
            // user denied, proceed without compass
          }
        } else {
          attachCompass();
        }

        // Start GPS
        if (navigator.geolocation) {
          watchId = navigator.geolocation.watchPosition(
            (pos) => {
              myPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
              updateCarMarker();
              if (routingActive) routeToUser();
              else if (userPos) fitToBoth();
            },
            (err) => setStatus("GPS error: " + err.message),
            { enableHighAccuracy: true, maximumAge: 2000, timeout: 15000 }
          );
        } else {
          setStatus("Geolocation not supported.");
        }

        // Listen to RTDB user location
        const userRef = ref(db, USER_LOCATION_RTD_PATH);
        rtdbUnsubscribe = onValue(userRef, (snap) => {
          const val = snap.val();
          if (val && isFinite(val.lat) && isFinite(val.lng)) {
            userPos = { lat: Number(val.lat), lng: Number(val.lng) };
            personMarker.position = userPos;
            if (!routingActive && myPos) fitToBoth();
            if (routingActive) routeToUser();
          } else {
            setStatus("Waiting RTDB user location…");
          }
        });

        routingActive = true;
        toggleButtons(true);
        setStatus("Live: routing to user");
      } catch (e) {
        setStatus("Start failed: " + e.message);
      }
    }

    function stopAll() {
      routingActive = false;
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      if (rtdbUnsubscribe) {
        off(ref(db, USER_LOCATION_RTD_PATH));
        rtdbUnsubscribe = null;
      }
      directionsRenderer.setDirections({ routes: [] }); // clear
      setStatus("Stopped");
      toggleButtons(false);
    }

    function toggleButtons(running) {
      document.getElementById("startBtn").disabled = running;
      document.getElementById("stopBtn").disabled = !running;
    }

    // ======= Compass (device heading) =======
    function attachCompass() {
      window.addEventListener("deviceorientationabsolute", handleOrientation, true);
      // fallback event
      window.addEventListener("deviceorientation", handleOrientation, true);
    }
    function handleOrientation(e) {
      // iOS gives webkitCompassHeading (0=N, clockwise). Else use alpha (0-360)
      let heading = null;
      if (typeof e.webkitCompassHeading === "number") {
        heading = e.webkitCompassHeading;
      } else if (typeof e.alpha === "number") {
        // e.alpha: 0 = device facing north (in degrees) in absolute mode
        // Try to use absolute if available; otherwise, ignore (may be relative)
        if (e.absolute === true || e.absolute === undefined) {
          heading = 360 - e.alpha; // convert to compass-like 0=N clockwise
        }
      }
      if (heading !== null && isFinite(heading)) {
        compassHeading = (heading + 360) % 360;
        applyCarRotation();
      }
    }

    // ======= Routing =======
    function routeToUser() {
      if (!myPos || !userPos) return;
      directionsService.route(
        {
          origin: myPos,
          destination: userPos,
          travelMode: google.maps.TravelMode.DRIVING,
          provideRouteAlternatives: false
        },
        (res, status) => {
          if (status === "OK" && res.routes && res.routes.length) {
            directionsRenderer.setDirections(res);
            // Keep view sensible on mobile—follow car if close, else fit both.
            const distMeters = google.maps.geometry
              ? google.maps.geometry.spherical.computeDistanceBetween(
                  new google.maps.LatLng(myPos), new google.maps.LatLng(userPos)
                )
              : null;
            if (distMeters !== null && distMeters < 800) {
              map.panTo(myPos);
            } else {
              fitToBoth();
            }
          } else {
            setStatus("Route error: " + status);
          }
        }
      );
    }

    // ======= Markers / View =======
    function updateCarMarker() {
      if (!myPos) return;
      carMarker.position = myPos;
      // If no compass yet, approximate heading by bearing to the user (if any)
      if (compassHeading === null && userPos) {
        const bearing = computeBearing(myPos, userPos); // 0=N
        compassHeading = bearing;
      }
      applyCarRotation();
    }

    function applyCarRotation() {
      if (compassHeading === null) return;
      // Rotate the HTML car element; 0deg should point "up" (north)
      carContentEl.style.transform = `rotate(${compassHeading}deg)`;
    }

    function fitToBoth() {
      const bounds = new google.maps.LatLngBounds();
      let added = false;
      if (myPos) { bounds.extend(myPos); added = true; }
      if (userPos) { bounds.extend(userPos); added = true; }
      if (added) {
        map.fitBounds(bounds, 80);
        // avoid zooming too far in on same point
        google.maps.event.addListenerOnce(map, 'bounds_changed', () => {
          if (map.getZoom() > 18) map.setZoom(18);
        });
      }
    }

    function setStatus(msg) {
      document.getElementById("status").textContent = msg;
      // also log
      console.log("[Status]", msg);
    }

    // ======= Utils =======
    function toRad(deg){ return deg * Math.PI / 180; }
    function toDeg(rad){ return rad * 180 / Math.PI; }
    function computeBearing(a, b) {
      const φ1 = toRad(a.lat), φ2 = toRad(b.lat);
      const Δλ = toRad(b.lng - a.lng);
      const y = Math.sin(Δλ) * Math.cos(φ2);
      const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
      return ( (toDeg(Math.atan2(y, x)) + 360) % 360 );
    }

    // ======= SVG Icons (inline) =======
    function carSVG() {
      // Simple forward-facing car (points up by default)
      return `
        <svg viewBox="0 0 100 100" width="40" height="40" aria-hidden="true">
          <defs>
            <linearGradient id="gcar" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%" stop-color="#4da3ff"/>
              <stop offset="100%" stop-color="#2f6ae6"/>
            </linearGradient>
          </defs>
          <g>
            <rect x="28" y="70" width="12" height="18" rx="3" fill="#0b0b0c"/>
            <rect x="60" y="70" width="12" height="18" rx="3" fill="#0b0b0c"/>
            <path d="M50 8 L70 36 Q74 42 74 52 L74 72 Q74 80 66 84 L34 84 Q26 80 26 72 L26 52 Q26 42 30 36 Z" fill="url(#gcar)" stroke="#0e1b33" stroke-width="2"/>
            <rect x="36" y="28" width="28" height="14" rx="3" fill="#cfe6ff" stroke="#0e1b33" stroke-width="2"/>
            <circle cx="50" cy="16" r="6" fill="#ff385c"/>
          </g>
        </svg>`;
    }
    function carMiniSVG(){ return `<svg viewBox="0 0 100 100" width="18" height="18"><path d="M50 8 L70 36 Q74 42 74 52 L74 72 Q74 80 66 84 L34 84 Q26 80 26 72 L26 52 Q26 42 30 36 Z" fill="#4da3ff"/></svg>`; }

    function personSVG() {
      return `
        <svg viewBox="0 0 64 64" width="36" height="36" aria-hidden="true">
          <defs>
            <linearGradient id="gpin" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%" stop-color="#00d084"/>
              <stop offset="100%" stop-color="#00a870"/>
            </linearGradient>
          </defs>
          <path d="M32 4c-10.5 0-19 8.5-19 19 0 14.2 19 37 19 37s19-22.8 19-37c0-10.5-8.5-19-19-19z" fill="url(#gpin)"/>
          <circle cx="32" cy="18" r="7" fill="#fff"/>
          <rect x="24" y="28" width="16" height="12" rx="4" fill="#fff"/>
        </svg>`;
    }
    function personMiniSVG(){ return `<svg viewBox="0 0 64 64" width="18" height="18"><path d="M32 4c-10.5 0-19 8.5-19 19 0 14.2 19 37 19 37s19-22.8 19-37c0-10.5-8.5-19-19-19z" fill="#00d084"/></svg>`; }

    // ======= Boot =======
    window.initMap = initMap;
    // Google Maps v=beta runs immediately; but to be safe:
    if (document.readyState === "complete" || document.readyState === "interactive") {
      setTimeout(initMap, 0);
    } else {
      document.addEventListener("DOMContentLoaded", initMap);
    }
  </script>

  <!-- Optional: geometry library for distance (used in routeToUser for the near/far pan heuristic) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjdnkFWOnh1u2cWf5RFURytU8Zk3fmOhk" defer></script>
</body>
</html>
