<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Real-time Location & Drop-off</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: Arial, sans-serif;
    background: #1e293b;
    color: #e2e8f0;
    overflow: hidden; /* prevent scroll */
  }

  #map {
    height: 100vh; /* full viewport height */
    width: 100%;
  }

  #dropoff-container {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    background: #0f172a;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
    width: 95%;
    max-width: 360px; /* smaller max-width */
    padding: 6px; /* smaller padding */
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  }

  #dropoff {
    flex: 1;
    padding: 8px;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #64748b;
    background: #1e293b;
    color: #f8fafc;
  }

  #saveBtn {
    padding: 8px 12px;
    font-size: 16px;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    flex-shrink: 0;
  }

  #saveBtn:hover {
    background: #2563eb;
  }

  /* Small screens stack input + button */
  @media (max-width: 95%;) {
    #dropoff-container {
      flex-direction: column;
      align-items: stretch;
      padding: 4px;
      gap: 4px;
    }
    #dropoff, #saveBtn {
      width: 90%;
      font-size: 18px;
      padding: 8px;
    }
  }
</style>
</head>
<body>
  <div id="dropoff-container">
    <input id="dropoff" type="text" placeholder="Entrer destination">
    <button id="saveBtn">Confirmer</button>
  </div>
  <div id="map"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjdnkFWOnh1u2cWf5RFURytU8Zk3fmOhk&libraries=places"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAIlkvwyaF6FPPbXBJDqHwuTS5S3QKG3l8",
      authDomain: "xoxo-store.firebaseapp.com",
      databaseURL: "https://xoxo-store-default-rtdb.firebaseio.com",
      projectId: "xoxo-store",
      storageBucket: "xoxo-store.firebasestorage.app",
      messagingSenderId: "667290233046",
      appId: "1:667290233046:web:dbbc9130ff38b0900f8177",
      measurementId: "G-XMJVCK8KMD"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const riderId = "A0000001";

    let map, geocoder, directionsService, directionsRenderer;
    let userMarker, dropoffMarker;
    let lastDropoffLocation = null;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 0, lng: 0 },
        zoom: 15,
        styles: [
          { elementType: 'geometry', stylers: [{color: '#0f172a'}]},
          { elementType: 'labels.text.stroke', stylers: [{color: '#1e293b'}]},
          { elementType: 'labels.text.fill', stylers: [{color: '#e2e8f0'}]},
          { featureType: 'road', elementType: 'geometry', stylers: [{color: '#1e293b'}]},
          { featureType: 'road', elementType: 'labels.text.fill', stylers: [{color: '#e2e8f0'}]}
        ],
        gestureHandling: "greedy"
      });

      geocoder = new google.maps.Geocoder();
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        suppressMarkers: true,
        polylineOptions: { strokeColor: "#3b82f6", strokeWeight: 5 }
      });

      const personIcon = {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 10,
        fillColor: "#3b82f6",
        fillOpacity: 1,
        strokeWeight: 2,
        strokeColor: "#1e293a"
      };

      if (navigator.geolocation) {
        navigator.geolocation.watchPosition((posData) => {
          const pos = { lat: posData.coords.latitude, lng: posData.coords.longitude };
          if (!userMarker) userMarker = new google.maps.Marker({ position: pos, map: map, icon: personIcon, title: "You" });
          else userMarker.setPosition(pos);
          map.setCenter(pos);

          db.ref(`Riders/${riderId}/PICK_UP_LOCATION`).set(pos).catch(console.error);

          if (lastDropoffLocation) drawRoute(pos, lastDropoffLocation);
        }, console.error, { enableHighAccuracy: true, maximumAge: 0 });
      } else alert("Geolocation not supported");

      const input = document.getElementById("dropoff");
      const autocomplete = new google.maps.places.Autocomplete(input);
      autocomplete.bindTo("bounds", map);

      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;

        const loc = place.geometry.location;

        if (dropoffMarker) dropoffMarker.setMap(null);
        dropoffMarker = new google.maps.Marker({ position: loc, map: map, title: "Drop-off", icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" });

        lastDropoffLocation = loc;

        if (userMarker) drawRoute(userMarker.getPosition(), loc);
        map.panTo(loc);
      });

      document.getElementById("saveBtn").addEventListener("click", () => {
        if (!lastDropoffLocation) return alert("Choisir adresse SVP!");

        geocoder.geocode({ location: lastDropoffLocation }, (results, status) => {
          if (status === "OK" && results[0]) {
            db.ref(`Riders/${riderId}/DROP_OFF_LOCATION`).set({
              lat: lastDropoffLocation.lat(),
              lng: lastDropoffLocation.lng(),
              address: results[0].formatted_address
            }).then(() => alert("Drop-off saved!")).catch(console.error);
          } else alert("Imposible d'enregistrer !: " + status);
        });
      });
    }

    function drawRoute(origin, dest) {
      directionsService.route({ origin, destination: dest, travelMode: "DRIVING" }, (resp, status) => {
        if (status === "OK") directionsRenderer.setDirections(resp);
      });
    }

    window.onload = initMap;
  </script>
</body>
</html>
